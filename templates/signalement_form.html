{% extends 'base.html' %}

{% block title %}Signaler une pollution - Rad0{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <h2 class="mb-4">Signaler une pollution</h2>

            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}

                <div class="mb-3">
                    <label class="form-label">Position du déchet (cliquez sur la carte)</label>
                    <div id="map" style="height: 400px;"></div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.latitude.id_for_label }}" class="form-label">Latitude</label>
                        {{ form.latitude }}
                        {% if form.latitude.errors %}
                            <div class="invalid-feedback d-block">{{ form.latitude.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.longitude.id_for_label }}" class="form-label">Longitude</label>
                        {{ form.longitude }}
                        {% if form.longitude.errors %}
                            <div class="invalid-feedback d-block">{{ form.longitude.errors }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="mb-3">
                    <label for="{{ form.type_dechet.id_for_label }}" class="form-label">Type de déchet</label>
                    {{ form.type_dechet }}
                    {% if form.type_dechet.errors %}
                        <div class="invalid-feedback d-block">{{ form.type_dechet.errors }}</div>
                    {% endif %}
                </div>

                <div class="mb-3">
                    <label for="{{ form.description.id_for_label }}" class="form-label">Description</label>
                    {{ form.description }}
                    {% if form.description.errors %}
                        <div class="invalid-feedback d-block">{{ form.description.errors }}</div>
                    {% endif %}
                </div>

                <div class="mb-3">
                    <label for="{{ form.photo.id_for_label }}" class="form-label">Photo (optionnel)</label>
                    {{ form.photo }}
                    {% if form.photo.errors %}
                        <div class="invalid-feedback d-block">{{ form.photo.errors }}</div>
                    {% endif %}
                </div>

                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-warning">Signaler</button>
                    <a href="{% url 'carte' %}" class="btn btn-secondary">Annuler</a>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const map = L.map('map').setView([48.39, -4.48], 12);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    let marker;
    const latInput = document.getElementById('{{ form.latitude.id_for_label }}');
    const lngInput = document.getElementById('{{ form.longitude.id_for_label }}');

    map.on('click', function(e) {
        if (marker) {
            map.removeLayer(marker);
        }
        marker = L.marker(e.latlng, {
            icon: L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                shadowSize: [41, 41]
            })
        }).addTo(map);
        latInput.value = e.latlng.lat.toFixed(6);
        lngInput.value = e.latlng.lng.toFixed(6);
    });
</script>
{% endblock %}
