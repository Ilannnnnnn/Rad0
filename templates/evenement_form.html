{% extends 'base.html' %}

{% block title %}{% if evenement %}Modifier{% else %}Créer{% endif %} un événement - Rad0{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <h2 class="mb-4">{% if evenement %}Modifier{% else %}Créer{% endif %} un événement</h2>

            <form method="post" class="needs-validation">
                {% csrf_token %}

                <div class="mb-3">
                    <label for="{{ form.titre.id_for_label }}" class="form-label">Titre</label>
                    {{ form.titre }}
                    {% if form.titre.errors %}
                        <div class="invalid-feedback d-block">{{ form.titre.errors }}</div>
                    {% endif %}
                </div>

                <div class="mb-3">
                    <label for="{{ form.description.id_for_label }}" class="form-label">Description</label>
                    {{ form.description }}
                    {% if form.description.errors %}
                        <div class="invalid-feedback d-block">{{ form.description.errors }}</div>
                    {% endif %}
                </div>

                <div class="mb-3">
                    <label for="{{ form.date.id_for_label }}" class="form-label">Date et heure</label>
                    {{ form.date }}
                    {% if form.date.errors %}
                        <div class="invalid-feedback d-block">{{ form.date.errors }}</div>
                    {% endif %}
                </div>

                <div class="mb-3">
                    <label for="{{ form.lieu.id_for_label }}" class="form-label">Lieu</label>
                    {{ form.lieu }}
                    {% if form.lieu.errors %}
                        <div class="invalid-feedback d-block">{{ form.lieu.errors }}</div>
                    {% endif %}
                </div>

                <div class="mb-3">
                    <label class="form-label">Position sur la carte (cliquez pour définir)</label>
                    <div id="map" style="height: 400px;"></div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.latitude.id_for_label }}" class="form-label">Latitude</label>
                        {{ form.latitude }}
                        {% if form.latitude.errors %}
                            <div class="invalid-feedback d-block">{{ form.latitude.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.longitude.id_for_label }}" class="form-label">Longitude</label>
                        {{ form.longitude }}
                        {% if form.longitude.errors %}
                            <div class="invalid-feedback d-block">{{ form.longitude.errors }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.max_participants.id_for_label }}" class="form-label">Nombre max de participants</label>
                        {{ form.max_participants }}
                        {% if form.max_participants.errors %}
                            <div class="invalid-feedback d-block">{{ form.max_participants.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.difficulte.id_for_label }}" class="form-label">Difficulté</label>
                        {{ form.difficulte }}
                        {% if form.difficulte.errors %}
                            <div class="invalid-feedback d-block">{{ form.difficulte.errors }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="mb-3 form-check">
                    {{ form.famille }}
                    <label class="form-check-label" for="{{ form.famille.id_for_label }}">
                        Adapté aux familles
                    </label>
                </div>

                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary">{% if evenement %}Modifier{% else %}Créer{% endif %}</button>
                    <a href="{% if evenement %}{% url 'evenement_detail' evenement.pk %}{% else %}{% url 'carte' %}{% endif %}" class="btn btn-secondary">Annuler</a>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const map = L.map('map').setView([48.39, -4.48], 12);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    let marker;
    const latInput = document.getElementById('{{ form.latitude.id_for_label }}');
    const lngInput = document.getElementById('{{ form.longitude.id_for_label }}');

    {% if evenement %}
        marker = L.marker([{{ evenement.latitude }}, {{ evenement.longitude }}]).addTo(map);
        map.setView([{{ evenement.latitude }}, {{ evenement.longitude }}], 15);
    {% endif %}

    map.on('click', function(e) {
        if (marker) {
            map.removeLayer(marker);
        }
        marker = L.marker(e.latlng).addTo(map);
        latInput.value = e.latlng.lat.toFixed(6);
        lngInput.value = e.latlng.lng.toFixed(6);
    });
</script>
{% endblock %}
